<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BL: The Choice</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@400;700&display=swap');
        
        @font-face { 
            font-family: 'Cafe24Danjeonghae'; 
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/Cafe24Danjeonghae.woff') format('woff'); 
            font-weight: normal; 
            font-style: normal; 
        }
        
        body {
            font-family: 'Cafe24Danjeonghae', 'Noto Sans KR', sans-serif;
            background-color: #000;
            color: white;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-scale-up { animation: scaleUp 0.2s ease-out forwards; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .animate-breathe { animation: breathe 4s ease-in-out infinite; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 2px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        /* App Container - Responsive for Landscape/Portrait */
        #root {
            width: 100vw;
            height: 100vh;
            background-color: #00264B;
            position: relative;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icon Component ---
        const Icon = ({ name, size = 24, color = "currentColor", className = "" }) => {
            const [iconNode, setIconNode] = useState(null);

            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                    setIconNode(window.lucide.icons[name]);
                }
            }, [name]);

            if (!iconNode) return <span className="w-6 h-6 block" />;
            const [tag, attrs, children] = iconNode;
            
            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke={color}
                    strokeWidth={2}
                    strokeLinecap={2}
                    strokeLinejoin="round"
                    className={className}
                    {...attrs}
                >
                    {children.map((child, index) => {
                        const [childTag, childAttrs] = child;
                        return React.createElement(childTag, { ...childAttrs, key: index });
                    })}
                </svg>
            );
        };

        // --- Data Constants ---
        const GENRES = [
          { id: 'daily', title: '일상&로맨스', desc: '학원/캠퍼스/오피스', color: 'from-pink-400 to-rose-500', iconName: 'Heart' },
          { id: 'modern', title: '현대&장르', desc: '느와르/연예계/판타지', color: 'from-green-500 to-emerald-600', iconName: 'Zap' },
          { id: 'fantasy', title: '시대&판타지', desc: '동양/서양/마법', color: 'from-purple-500 to-violet-700', iconName: 'Moon' },
        ];

        const WORLDS = [
          { id: 'basic', title: '기본 (Basic)', desc: '현실적인 로맨스' },
          { id: 'guide', title: '가이드버스', desc: '에스퍼 & 가이드' },
          { id: 'omega', title: '오메가버스', desc: '알파/오메가/베타' },
          { id: 'beast', title: '수인물', desc: '동물적 본능' },
          { id: 'soul', title: '소울메이트', desc: '네임버스/컬러버스' },
        ];

        const GAME_TIPS = [
          "TIP. 호감도가 일정 수준 이상이어야 히든 엔딩을 볼 수 있습니다.",
          "TIP. 메인 로비의 캐릭터를 터치하면 특별한 반응을 보입니다.",
          "TIP. 선택지에 따라 공략 캐릭터의 반응이 달라집니다.",
          "TIP. 매일 자정에 무료 티켓이 5장 충전됩니다.",
          "TIP. 상점에서 특별한 코스튬을 구매하여 호감도를 빠르게 올리세요.",
          "TIP. 지난 스토리는 '서재'에서 다시 감상할 수 있습니다.",
        ];

        const BANNERS_PRIMARY = [
          { id: 1, tag: "NOTICE", tagColor: "bg-blue-400 text-white", title: "12월 신작 캘린더", desc: "이달의 화제작을 미리 만나보세요.", bgGradient: "from-blue-900 to-slate-800", patternOpacity: "opacity-10", icon: "Calendar" },
          { id: 2, tag: "EVENT", tagColor: "bg-red-500 text-white", title: "HAPPY NEW YEAR", desc: "신년 맞이 특별 이벤트 진행 중!", bgGradient: "from-red-900 to-orange-900", patternOpacity: "opacity-10", icon: "Gift" },
          { id: 3, tag: "SALE", tagColor: "bg-yellow-400 text-black", title: "인기작 30% 할인", desc: "지금 정주행하기 딱 좋은 기회!", bgGradient: "from-purple-900 to-indigo-900", patternOpacity: "opacity-10", icon: "CreditCard" }
        ];

        const BANNERS_SECONDARY = [
          { id: 4, tag: "GUIDE", tagColor: "bg-green-400 text-black", title: "히든 엔딩 해금", desc: "공략 팁을 확인하세요.", bgGradient: "from-green-700 to-teal-800", patternOpacity: "opacity-10", icon: "Key" },
          { id: 5, tag: "RANKING", tagColor: "bg-pink-400 text-white", title: "주간 베스트 TOP 10", desc: "가장 많이 본 작품을 만나보세요.", bgGradient: "from-pink-800 to-purple-800", patternOpacity: "opacity-10", icon: "Trophy" },
          { id: 6, tag: "AUTHOR", tagColor: "bg-indigo-400 text-white", title: "작가 신작 알림", desc: "최애 작가의 새 소식을 확인!", bgGradient: "from-indigo-800 to-blue-800", patternOpacity: "opacity-10", icon: "Bell" }
        ];

        const ITEMS = [
            { id: 1, name: "추억의 조각", price: "1,000 G", icon: "Sparkles", desc: "특별한 기억을 해금합니다." },
            { id: 2, name: "비밀 열쇠", price: "500 G", icon: "Key", desc: "잠겨있는 선택지를 엽니다." },
            { id: 3, name: "호감도 포션", price: "3,000 G", icon: "Heart", desc: "캐릭터의 호감도를 대폭 상승시킵니다." },
            { id: 4, name: "VIP 티켓", price: "50 장", icon: "Ticket", desc: "프리미엄 에피소드 입장권." },
            { id: 5, name: "캐릭터 슬롯", price: "5,000 G", icon: "User", desc: "저장 가능한 캐릭터 슬롯을 확장합니다." },
            { id: 6, name: "랜덤 박스", price: "800 G", icon: "Gift", desc: "무엇이 나올지 모르는 행운의 박스." }
        ];

        const PURCHASED_BOOKS = [
            { id: 101, title: '차가운 밤의 구원', type: '웹툰', isExclusive: true, progress: 65 },
            { id: 102, title: '이웃집 길드원', type: '웹툰', isExclusive: true, progress: 100 },
            { id: 103, title: '스케치', type: '웹툰', isExclusive: false, progress: 30 },
            { id: 104, title: '불우한 삶', type: '웹소설', isExclusive: false, progress: 0 },
            { id: 105, title: '물가의 밤', type: '웹툰', isExclusive: false, progress: 100 },
        ];

        const EXCLUSIVE_NEW_RELEASES = [
            { title: "징크스", author: "밍과", tags: "현대/일상", icon: "Crown", coverColor: "bg-purple-700" },
            { title: "야화첩", author: "변덕", tags: "동양/시대물", icon: "Shield", coverColor: "bg-red-700" },
            { title: "페이백", author: "푸죠킹", tags: "현대/일상", icon: "Key", coverColor: "bg-indigo-700" },
        ];

        const LATEST_NEW_RELEASES = [
            { title: "원룸 조교님", author: "지붕", tags: "현대", icon: "Users", coverColor: "bg-green-700" },
            { title: "가족간계증명서", author: "E 작가", tags: "현대/판타지", icon: "RefreshCcw", coverColor: "bg-blue-700" },
            { title: "홍실퀘스트", author: "숲이랑", tags: "현대/판타지", icon: "Heart", coverColor: "bg-pink-700" },
        ];

        const REALTIME_SEARCH_TERMS = [
            '불우한 삶', '이웃집 길드원', '패션', '뉴비와 올드비의 공생관계', '스케치'
        ];
        
        const SPLASH_STEPS = [
            { 
                label: "DEVELOPER", 
                type: 'single',
                logoComponent: (
                    <div className="flex flex-col items-center justify-center">
                        <div className="flex items-center gap-2 mb-4 animate-bounce">
                             <div className="flex">
                                <div className="w-10 h-10 border-4 border-orange-500 rounded-l-full border-r-0"></div>
                                <div className="w-10 h-10 border-4 border-orange-500 rounded-l-full border-r-0 transform rotate-180 -ml-2"></div>
                            </div>
                        </div>
                        <h1 className="text-xl md:text-2xl font-bold text-white tracking-wide">ChungKang College of</h1>
                        <h1 className="text-xl md:text-2xl font-bold text-white tracking-wide">Cultural Industries</h1>
                    </div>
                )
            },
            { 
                label: "GLOBAL PARTNERS", 
                type: 'group',
                entities: [
                    { name: "KAKAO ENTERTAINMENT", kr: "카카오엔터테인먼트", icon: "Star", color: "text-yellow-400" },
                    { name: "(주)KIDARI STUDIO", kr: "(주)키다리스튜디오", icon: "Book", color: "text-red-500" },
                    { name: "RIDI CORPORATION", kr: "리디 주식회사", icon: "Monitor", color: "text-blue-400" },
                ] 
            },
        ];


        // --- Utils ---
        const playSoundEffect = () => {};

        // --- Snow Effect ---
        const SnowEffect = () => {
          const particles = useMemo(() => Array.from({ length: 50 }).map((_, i) => ({
              id: i,
              left: Math.random() * 100 + '%',
              animationDuration: Math.random() * 15 + 20 + 's', 
              animationDelay: '-' + (Math.random() * 30) + 's', 
              opacity: Math.random() * 0.6 + 0.1,
              width: Math.random() * 2 + 1 + 'px',
              height: Math.random() * 2 + 1 + 'px',
              drift: (Math.random() - 0.5) * 150 + 'px',
              rotation: Math.random() * 360 + 'deg'
            })), []);

          return (
            <div className="absolute inset-0 pointer-events-none z-50 overflow-hidden mix-blend-screen">
              <style>{`@keyframes floatParticle { 0% { transform: translateY(-10px) translateX(0) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 50% { opacity: 0.8; } 100% { transform: translateY(110vh) translateX(var(--drift)) rotate(360deg); opacity: 0; } }`}</style>
              {particles.map((p) => (
                <div key={p.id} className="absolute bg-white blur-[0.5px]" style={{ left: p.left, top: '-10px', width: p.width, height: p.height, opacity: p.opacity, '--drift': p.drift, transform: `rotate(${p.rotation})`, animation: `floatParticle ${p.animationDuration} linear infinite`, animationDelay: p.animationDelay, borderRadius: '1px' }} />
              ))}
            </div>
          );
        };
        
        // --- Custom Banner Carousel Component ---
        const BannerCarousel = ({ banners, currentIdx, playSfx, onPlay, className }) => {
            const currentBanner = banners[currentIdx];
            if (!currentBanner) return null;

            return (
                <section 
                    className={`w-full h-48 md:h-64 rounded-2xl flex items-center justify-between px-8 border border-white/10 relative overflow-hidden cursor-pointer group shadow-xl transition-all duration-500 ${currentBanner.bgGradient} ${className}`}
                    onClick={onPlay}
                >
                    <div className={`absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] ${currentBanner.patternOpacity}`}></div>
                    <div className="absolute right-0 top-0 bottom-0 w-1/2 bg-gradient-to-l from-black/50 to-transparent"></div>
                    
                    <div className="z-10 relative animate-fade-in w-3/4" key={currentBanner.id}>
                        <span className={`text-xs font-bold px-3 py-1 rounded mb-3 inline-block ${currentBanner.tagColor}`}>{currentBanner.tag}</span>
                        <h3 className="text-2xl font-bold italic text-white mb-2 leading-tight drop-shadow-md">{currentBanner.title}</h3>
                        <p className="text-sm text-gray-200">{currentBanner.desc}</p>
                    </div>
                    
                    <div className="z-10 bg-white/10 p-2 rounded-full group-hover:bg-white/20 transition-colors transform group-hover:translate-x-1">
                        <Icon name="ChevronRight" className="w-6 h-6 text-white" />
                    </div>

                    {/* Indicators */}
                    <div className="absolute bottom-4 right-1/2 translate-x-1/2 flex gap-2">
                        {banners.map((_, idx) => (
                            <div key={idx} className={`w-1.5 h-1.5 rounded-full transition-colors ${idx === currentIdx ? 'bg-white' : 'bg-white/30'}`}></div>
                        ))}
                    </div>
                </section>
            );
        };


        // --- Screens ---

        function LoadingScreen({ onComplete }) {
          const [progress, setProgress] = useState(0);
          const [tip, setTip] = useState('');

          useEffect(() => {
            setTip(GAME_TIPS[Math.floor(Math.random() * GAME_TIPS.length)]);
            const interval = setInterval(() => {
              setProgress((prev) => { const next = prev + Math.random() * 3; return next >= 100 ? 100 : next; });
            }, 50);
            return () => clearInterval(interval);
          }, []);

          useEffect(() => { if (progress >= 100) setTimeout(onComplete, 500); }, [progress, onComplete]);
          const currentVal = Math.min(100, Math.floor(progress));

          return (
            <div className="w-full h-full flex flex-col justify-end pb-12 px-8 bg-[#00264B]/90 backdrop-blur-md animate-fade-in z-50 text-white absolute inset-0">
              <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center w-full">
                 <div className="w-16 h-16 border-4 border-t-blue-300 border-white/10 rounded-full animate-spin mx-auto mb-4 shadow-[0_0_15px_#00264B]"></div>
                 <h2 className="text-xl font-bold tracking-widest animate-pulse text-blue-100">데이터 다운로드 중...</h2>
              </div>
              <div className="w-full space-y-2">
                <div className="text-center mb-4"><p className="text-sm text-blue-200 font-medium animate-fade-in bg-black/20 py-2 px-4 rounded-lg inline-block">{tip}</p></div>
                <div className="w-full h-2 bg-black/40 rounded-full overflow-hidden border border-white/10"><div className="h-full bg-gradient-to-r from-blue-600 via-purple-500 to-pink-400 transition-all duration-75 ease-out" style={{ width: `${progress}%` }}></div></div>
                <div className="flex justify-between items-center text-xs text-blue-300 font-mono mt-1"><span>{currentVal}% 다운로드됨 ({currentVal}/100)</span><span>Ver. 1.3.0</span></div>
              </div>
            </div>
          );
        }

        function PermissionModal({ onConfirm, onCancel, playSfx }) {
          return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in px-4">
              <div className="w-full max-w-md bg-[#0f1524] border border-white/10 rounded-lg shadow-2xl overflow-hidden animate-scale-up">
                <div className="flex justify-between items-center px-6 py-4 border-b border-white/10 bg-[#00264B]/50">
                  <h2 className="text-lg font-bold text-white tracking-wider">알림</h2>
                  <button onClick={() => { playSfx(); onCancel(); }} className="text-gray-400 hover:text-white transition-colors"><Icon name="X" size={24} /></button>
                </div>
                <div className="p-6 space-y-6">
                  <div className="text-center space-y-2">
                    <p className="text-xl font-bold text-blue-100 mb-4">BL: The Choice</p>
                    <p className="text-gray-300 text-sm leading-relaxed">원활한 게임 플레이 환경을 제공하기 위해<br/>아래의 권한을 필요로 합니다.</p>
                  </div>
                  <div className="bg-black/40 p-4 rounded border border-white/10 text-center">
                    <p className="text-blue-200 font-bold text-sm">[필수] 외부 저장소에서 읽기 권한</p>
                  </div>
                  <p className="text-red-400 text-xs text-center">필수 권한을 거부하는 경우, 게임 설치가 진행되지 않습니다.</p>
                </div>
                <div className="flex border-t border-white/10">
                  <button onClick={() => { playSfx(); onCancel(); }} className="flex-1 py-4 bg-transparent text-gray-400 font-bold hover:bg-white/5 transition-colors border-r border-white/10">취소</button>
                  <button onClick={() => { playSfx(); onConfirm(); }} className="flex-1 py-4 bg-blue-900/50 text-white font-bold hover:bg-blue-800 transition-colors">확인</button>
                </div>
              </div>
            </div>
          );
        }

        function SplashScreen({ onComplete }) {
            const [step, setStep] = useState(0); // 0: Developer, 1: Partners, 2: Complete

            useEffect(() => {
                const currentData = SPLASH_STEPS[step];
                if (!currentData) {
                    const finalTimer = setTimeout(onComplete, 500); 
                    return () => clearTimeout(finalTimer);
                }

                const duration = currentData.type === 'single' ? 2500 : 3500; // Developer: 2.5s, Partners: 3.5s
                
                const timer = setTimeout(() => {
                    setStep(prev => prev + 1);
                }, duration);
                return () => clearTimeout(timer);
            }, [step, onComplete]);

            const current = SPLASH_STEPS[step];
            if (!current) return null;

            // Render Developer Screen
            if (current.type === 'single') {
                return (
                    <div onClick={onComplete} className="w-full h-full flex flex-col items-center justify-center bg-black animate-fade-in z-50 cursor-pointer text-white absolute inset-0">
                        <div className="flex flex-col items-center gap-6 animate-fade-in-up transition-all duration-500">
                             {/* Render Logo Component */}
                             {current.logoComponent}
                        </div>
                    </div>
                );
            }
            
            // Render Partner Group Screen
            if (current.type === 'group') {
                 return (
                    <div onClick={onComplete} className="w-full h-full flex flex-col items-center justify-center bg-black animate-fade-in z-50 cursor-pointer text-white absolute inset-0">
                        <div className="flex flex-col items-center gap-12 w-full max-w-4xl px-6 animate-fade-in-up">
                            <h2 className="text-gray-500 text-sm tracking-[0.3em] uppercase opacity-70">
                                {current.label}
                            </h2>
                            <div className="flex flex-wrap justify-center gap-8 w-full">
                                {current.entities.map((entity, idx) => (
                                    <div key={idx} className="flex flex-col items-center gap-4 text-center" style={{animationDelay: `${idx * 0.2}s`}}>
                                        <div className={`w-16 h-16 ${entity.color.replace('text', 'bg').replace('400', '500')}/20 rounded-2xl flex items-center justify-center shadow-lg transition-transform hover:scale-110`}>
                                            <Icon name={entity.icon} className={`w-8 h-8 ${entity.color}`} />
                                        </div>
                                        <div className='flex flex-col gap-1'>
                                            <span className={`text-sm md:text-base font-bold tracking-wider text-white whitespace-nowrap`}>
                                                {entity.kr}
                                            </span>
                                            <p className={`text-[10px] text-gray-500 uppercase tracking-widest`}>
                                                {entity.name}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                 );
            }
            
            return null;
        }

        // --- Responsive Navigation ---
        function ResponsiveNavigation({ currentScreen, onNavigate, playSfx, isSidebarOpen }) {
          const navItems = [
            { id: 'shop', label: '상점', icon: 'ShoppingBag' },
            { id: 'library', label: '서재', icon: 'Book' },
            { id: 'lobby', label: '홈', icon: 'Home' },
            { id: 'profile', label: '프로필', icon: 'User' },
            { id: 'myhome', label: '마이홈', icon: 'Heart' }, 
            { id: 'settings', label: '설정', icon: 'Settings' },
          ];

          return (
            <>
                {/* Mobile: Bottom Bar (Visible on portrait/small screens) */}
                <div className="md:hidden fixed bottom-0 left-0 right-0 bg-[#001a33]/95 border-t border-white/10 flex justify-around items-center py-3 pb-5 z-40 backdrop-blur-md shadow-[0_-5px_20px_rgba(0,0,0,0.3)]">
                  {navItems.map((item) => (
                    <button key={item.id} onClick={() => { playSfx(); onNavigate(item.id); }} className={`flex flex-col items-center gap-1 transition-all duration-300 ${currentScreen === item.id ? 'text-white transform -translate-y-1' : 'text-gray-500 hover:text-gray-300'}`}>
                      <Icon name={item.icon} className={`w-6 h-6 ${currentScreen === item.id ? 'text-blue-200 drop-shadow-[0_0_8px_rgba(191,219,254,0.6)]' : ''}`} />
                      <span className={`text-[10px] font-bold ${currentScreen === item.id ? 'text-blue-100' : ''}`}>{item.label}</span>
                    </button>
                  ))}
                </div>

                {/* Desktop/Landscape: Left Sidebar */}
                <div className={`hidden md:flex fixed top-0 bottom-0 w-24 bg-[#001a33]/95 border-r border-white/10 flex-col items-center py-8 z-40 backdrop-blur-md shadow-[5px_0_20px_rgba(0,0,0,0.3)] gap-8 transition-all duration-300 ${isSidebarOpen ? 'left-0' : '-left-24'}`}>
                  {navItems.map((item) => (
                    <button key={item.id} onClick={() => { playSfx(); onNavigate(item.id); }} className={`group flex flex-col items-center gap-2 transition-all duration-300 w-full relative ${currentScreen === item.id ? 'text-white' : 'text-gray-500 hover:text-gray-300'}`}>
                      {currentScreen === item.id && <div className="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-8 bg-blue-400 rounded-r-full shadow-[0_0_10px_#60a5fa]"></div>}
                      <Icon name={item.icon} className={`w-7 h-7 ${currentScreen === item.id ? 'text-blue-200 drop-shadow-[0_0_8px_rgba(191,219,254,0.6)]' : 'group-hover:scale-110 transition-transform'}`} />
                      <span className={`text-[11px] font-bold ${currentScreen === item.id ? 'text-blue-100' : ''}`}>{item.label}</span>
                    </button>
                  ))}
                </div>
            </>
          );
        }

        // --- Screens ---

        function TitleScreen({ onStart, isGuestMode, setIsGuestMode, onNavigate }) {
          const [showLoginMenu, setShowLoginMenu] = useState(false);

          const handleGuestPlay = (e) => {
            e.stopPropagation();
            setIsGuestMode(true);
            setShowLoginMenu(false);
            onStart(); // Start game flow immediately after selecting Guest
          };
          
          const handleLogin = (e) => {
            e.stopPropagation();
            // Simulate successful login
            setIsGuestMode(false); // Assume successful login means not a guest
            setShowLoginMenu(false);
            onStart(); // Start game flow immediately after login
          };
          
          const handleStartClick = (e) => {
            e.stopPropagation();
            // CENTRAL BUTTON LOGIC: Always start the game flow regardless of login status
            onStart();
          };

          const TopRightMenu = () => (
              <div className="absolute top-6 right-6 md:top-10 md:right-10 z-30 flex flex-col items-end space-y-2">
                  {[
                      { label: '공지사항', icon: 'Megaphone', dest: 'notice' },
                      { label: '환경설정', icon: 'Settings', dest: 'settings' },
                      { label: '고객센터', icon: 'Headphones', dest: 'help' }
                  ].map(item => (
                      <button 
                          key={item.label} 
                          onClick={(e) => { e.stopPropagation(); onNavigate(item.dest); }} 
                          className="text-xs md:text-sm text-white/70 hover:text-blue-300 transition-colors bg-black/40 px-3 py-1.5 rounded-full backdrop-blur-sm flex items-center gap-2"
                      >
                          <Icon name={item.icon} size={14} className="text-gray-400" />
                          <span>{item.label}</span>
                      </button>
                  ))}
              </div>
          );

          // New Bottom-Left Status/Login Button - Trigger for Modal
          const BottomLeftStatus = () => (
              <div className="absolute bottom-6 left-6 md:bottom-10 md:left-10 z-30">
                  <div className="relative">
                      {isGuestMode ? (
                          <div className="text-sm text-gray-400 bg-black/40 px-3 py-2 rounded-xl backdrop-blur-sm flex items-center gap-2">
                              <Icon name="Users" size={16} className="text-blue-300" />
                              게스트 모드 플레이 중
                          </div>
                      ) : (
                           <button 
                              onClick={(e) => { e.stopPropagation(); setShowLoginMenu(true); }} 
                              className="bg-black/40 hover:bg-black/60 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition-colors text-sm border border-white/20 flex items-center gap-2"
                          >
                              <Icon name="LogIn" size={16} className="text-gray-400" /> 로그인/회원가입
                          </button>
                      )}
                  </div>
              </div>
          );


          return (
            <div className="relative flex flex-col items-center justify-center h-full animate-fade-in text-center pb-20 absolute inset-0 z-20">
              
              <div className="absolute top-[20%] w-full h-[1px] bg-gradient-to-r from-transparent via-blue-200/30 to-transparent blur-[1px]"></div>
              <div className="absolute bottom-[20%] w-full h-[1px] bg-gradient-to-r from-transparent via-pink-200/50 to-transparent shadow-[0_0_15px_white]"></div>

              {/* 1. Logo (Top Left) */}
              <div className="absolute top-6 left-6 md:top-10 md:left-10 z-30">
                  <div className="text-xl font-bold italic text-white drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                      <Icon name="Gamepad2" size={24} className="inline mr-2 text-blue-300" />
                      T.C.
                  </div>
              </div>

              {/* 2. Top Right Menu */}
              <TopRightMenu />

              {/* Center Title */}
              <div className="flex flex-col justify-center items-center scale-100 md:scale-125 transition-transform duration-500">
                <div className="mb-6 animate-float">
                    <Icon name="Stars" size={64} className="text-yellow-200 opacity-80" />
                </div>
                <h1 className="text-6xl md:text-8xl font-serif font-bold text-white tracking-tighter drop-shadow-[0_0_25px_rgba(255,255,255,0.3)] mb-4">The Choice</h1>
                <p className="text-blue-200 tracking-[0.8em] text-sm md:text-lg uppercase font-light">Boy's Love Simulation</p>
              </div>
              
              {/* Main Action Button (Center) - ALWAYS STARTS GAME FLOW */}
              <div className="relative group cursor-pointer z-20 mt-20 animate-pulse" onClick={handleStartClick}>
                <div className="absolute inset-0 bg-white/10 blur-xl transform scale-110 group-hover:scale-125 group-hover:bg-white/30 transition-all duration-500" style={{ clipPath: "polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)" }}></div>
                <div className="relative w-64 h-32 bg-[#00264B]/40 border-2 border-white/60 flex items-center justify-center backdrop-blur-md group-hover:bg-white/10 transition-colors shadow-[0_0_20px_rgba(255,255,255,0.2)]" style={{ clipPath: "polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)" }}>
                    <div className="flex flex-col items-center justify-center pointer-events-none">
                        <span className="text-xl font-bold tracking-[0.2em] text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.8)] transition-all">
                            {isGuestMode ? '게임 다시 시작' : 'TAP TO START'}
                        </span>
                    </div>
                </div>
              </div>

              {/* New Bottom-Left Status/Login Button */}
              <BottomLeftStatus />

              {/* Login/Guest Menu Modal */}
              {showLoginMenu && (
                  <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/80 backdrop-blur-sm" onClick={(e) => { e.stopPropagation(); setShowLoginMenu(false); }}>
                      <div className="w-full max-w-sm bg-[#0f1524] border border-white/10 rounded-xl p-6 shadow-2xl animate-scale-up" onClick={(e) => e.stopPropagation()}>
                          <h3 className="text-xl font-bold text-white mb-4">플레이 모드를 선택하세요</h3>
                          <div className="space-y-4">
                              <button onClick={handleLogin} className="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-xl text-lg font-bold bg-blue-600 hover:bg-blue-500 text-white transition-colors shadow-md">
                                  <Icon name="LogIn" size={20} /> 정식 계정 로그인
                              </button>
                              <button onClick={handleGuestPlay} className="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-xl text-lg font-bold text-gray-300 hover:bg-white/10 transition-colors border border-gray-700">
                                  <Icon name="Users" size={20} /> 게스트로 플레이
                              </button>
                          </div>
                          <button onClick={() => setShowLoginMenu(false)} className="mt-4 w-full text-sm text-gray-500 hover:text-white transition-colors">
                              취소
                          </button>
                      </div>
                  </div>
              )}
            
              <div className="absolute bottom-6 text-xs text-white/40 z-20">© 2025 Edition BL. All Rights Reserved.</div>
            </div>
          );
        }

        function AgeGateScreen({ onSelect }) {
          return (
            <div className="flex flex-col items-center justify-center h-full bg-[#00264B]/60 backdrop-blur-md p-6 animate-fade-in absolute inset-0 z-30">
              <h2 className="text-3xl font-bold mb-12 text-white drop-shadow-lg font-serif">Select Your Version</h2>
              <div className="flex flex-col md:flex-row gap-8 w-full max-w-4xl justify-center">
                <div onClick={() => onSelect('15')} className="flex-1 cursor-pointer group bg-gradient-to-br from-[#1e2a45] to-[#0f1524] border border-blue-300/30 hover:border-blue-300 rounded-3xl p-8 flex flex-col items-center gap-6 transition-all hover:scale-105 shadow-xl relative overflow-hidden h-80 justify-center">
                   <div className="absolute -right-10 -top-10 w-40 h-40 bg-blue-500/20 rounded-full blur-2xl group-hover:bg-blue-500/30 transition-colors"></div>
                   <div className="w-20 h-20 bg-blue-500/20 rounded-full flex items-center justify-center flex-shrink-0 group-hover:bg-blue-500 transition-colors"><Icon name="Heart" className="w-10 h-10 text-blue-300 group-hover:text-white" /></div>
                   <div className="text-center z-10">
                     <h3 className="text-2xl font-bold text-blue-100 mb-2">개정판 (15+)</h3>
                     <p className="text-gray-400 text-sm">감성적인 스토리와 아름다운 연출.</p>
                   </div>
                </div>
                <div onClick={() => onSelect('19')} className="flex-1 cursor-pointer group bg-gradient-to-br from-[#3a1a1a] to-[#1a0a0a] border border-red-400/30 hover:border-red-400 rounded-3xl p-8 flex flex-col items-center gap-6 transition-all hover:scale-105 shadow-xl relative overflow-hidden h-80 justify-center">
                   <div className="absolute top-0 right-0 bg-red-800 text-white text-xs font-bold px-4 py-2 rounded-bl-2xl z-10">성인 인증 필요</div>
                   <div className="absolute -left-10 -bottom-10 w-40 h-40 bg-red-500/20 rounded-full blur-2xl group-hover:bg-red-500/30 transition-colors"></div>
                   <div className="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center flex-shrink-0 group-hover:bg-red-600 transition-colors"><Icon name="Lock" className="w-10 h-10 text-red-400 group-hover:text-white" /></div>
                   <div className="text-center z-10">
                     <h3 className="text-2xl font-bold text-red-200 mb-2">완전판 (19+)</h3>
                     <p className="text-gray-400 text-sm">무삭제 고수위 일러스트와 시나리오.</p>
                   </div>
                </div>
              </div>
              <p className="mt-12 text-sm text-gray-400 max-w-lg text-center leading-relaxed opacity-60">* 15세 버전을 모두 클리어하시면 완전판(19세) 구매 시 50% 할인 혜택이 적용됩니다.</p>
            </div>
          );
        }

        function FilterScreen({ userMode, onComplete, onRestart, playSfx }) {
          const [step, setStep] = useState(1);
          const [data, setData] = useState({ genre: null, world: null, bdsm: false });

          const handleNext = (key, value) => {
            playSfx();
            const newData = { ...data, [key]: value };
            setData(newData);
            if (step === 2) {
              if (userMode === '15') { setData({ ...newData, bdsm: false }); setStep(4); }
              else setStep(3);
            } else if (step === 3) setStep(4);
            else if (step < 2) setStep(step + 1);
          };

          const handleRetake = () => { playSfx(); onRestart(); }; 

          return (
            <div className="w-full h-full flex flex-col pt-12 pb-6 px-6 bg-[#00264B]/60 backdrop-blur-md absolute inset-0 z-30">
              <div className="w-full max-w-2xl mx-auto h-1 bg-white/10 mb-8 rounded-full"><div className="h-full bg-gradient-to-r from-blue-400 to-purple-400 transition-all duration-500" style={{ width: `${(Math.min(step, 3) / (userMode === '15' ? 2 : 3)) * 100}%` }}></div></div>
              <div className="flex-1 flex flex-col items-center justify-center animate-slide-up overflow-y-auto custom-scrollbar">
                {step === 1 && (
                  <>
                    <h2 className="text-3xl font-bold mb-8 text-white text-center font-serif">장르 선택</h2>
                    <div className="flex flex-col md:flex-row gap-4 w-full max-w-5xl justify-center">
                      {GENRES.map((g) => (
                        <button key={g.id} onClick={() => handleNext('genre', g)} className={`flex-1 relative overflow-hidden p-8 rounded-2xl border border-white/10 hover:border-white/50 transition-all hover:-translate-y-2 bg-gradient-to-br ${g.color} bg-opacity-20 flex flex-col items-center gap-4 group h-64 justify-center`}>
                          <div className="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors"></div>
                          <div className="relative z-10 p-4 bg-white/10 rounded-full backdrop-blur-sm text-white group-hover:scale-110 transition-transform"><Icon name={g.iconName} size={32} /></div>
                          <div className="relative z-10 text-center">
                            <h3 className="text-xl font-bold mb-2">{g.title}</h3>
                            <p className="text-sm opacity-80">{g.desc}</p>
                          </div>
                        </button>
                      ))}
                    </div>
                  </>
                )}
                {step === 2 && (
                  <>
                    <h2 className="text-3xl font-bold mb-8 text-white text-center font-serif">세계관 선택</h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 w-full max-w-6xl">
                      {WORLDS.map((w) => (
                        <button key={w.id} onClick={() => handleNext('world', w)} className="p-6 rounded-2xl bg-[#0f1524]/80 border border-white/10 hover:bg-white/10 hover:border-blue-300 transition-all flex flex-col items-center justify-center text-center aspect-square hover:-translate-y-1">
                          <div className="text-lg font-bold text-white mb-2">{w.title}</div>
                          <div className="text-xs text-gray-400 break-keep">{w.desc}</div>
                        </button>
                      ))}
                    </div>
                  </>
                )}
                {step === 3 && (
                  <div className="w-full max-w-xl bg-[#0f1524]/90 p-10 rounded-3xl border border-white/20 flex flex-col items-center shadow-2xl">
                        <div className="flex items-center justify-between w-full mb-8 bg-black/30 p-6 rounded-2xl">
                          <span className="text-xl font-bold">하드코어/BDSM 포함</span>
                          <button onClick={() => { playSfx(); const nextData = { ...data, bdsm: !data.bdsm }; setData(nextData); }} className={`w-16 h-7 rounded-full p-1 transition-all duration-300 ${data.bdsm ? 'bg-red-600' : 'bg-gray-600'}`}>
                            <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${data.bdsm ? 'translate-x-5' : ''}`}></div>
                          </button>
                        </div>
                        <p className="text-sm text-gray-300 text-center mb-10 bg-black/40 p-6 rounded-xl leading-relaxed w-full break-keep border border-white/5">
                          {data.bdsm ? <><span className="text-red-500 font-bold block mb-3 text-lg">※ 경고 ※</span>구속, 지배, 피지배 등 하드코어한 소재가 스토리에 포함됩니다.<br/>취향에 맞지 않으실 경우 플레이에 유의해주세요.</> : <>일반적인 로맨스와 캐릭터간의 관계성에 집중합니다.<br/>소프트한 스킨십 위주로 진행 됩니다.</>}
                        </p>
                        <button onClick={() => { playSfx(); setStep(4); }} className="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg rounded-xl transition-colors shadow-lg">선택 완료</button>
                  </div>
                )}
                {step === 4 && (
                  <div className="w-full max-w-lg bg-[#0f1524]/90 p-8 rounded-2xl border border-white/20 flex flex-col gap-6 animate-scale-up shadow-2xl">
                      <div className="space-y-4 text-base">
                        <div className="flex justify-between items-center border-b border-white/10 pb-3"><span className="text-gray-400">버전</span><span className={`font-bold text-lg ${userMode === '19' ? 'text-red-400' : 'text-blue-300'}`}>{userMode === '19' ? '19세 완전판' : '15세 개정판'}</span></div>
                        <div className="flex justify-between items-center border-b border-white/10 pb-3"><span className="text-gray-400">장르</span><span className="font-bold text-lg text-white">{data.genre?.title}</span></div>
                        <div className="flex justify-between items-center border-b border-white/10 pb-3"><span className="text-gray-400">세계관</span><span className="font-bold text-lg text-white">{data.world?.title}</span></div>
                        {userMode === '19' && <div className="flex justify-between items-center border-b border-white/10 pb-3"><span className="text-gray-400">취향</span><span className={`font-bold text-lg ${data.bdsm ? 'text-red-400' : 'text-blue-300'}`}>{data.bdsm ? '하드코어' : '노멀'}</span></div>}
                      </div>
                      <div className="flex gap-4 mt-4 justify-center">
                        <button onClick={handleRetake} className="flex-1 py-4 bg-gray-800 text-gray-300 font-bold rounded-xl hover:bg-gray-700 transition-colors flex items-center justify-center gap-2"><Icon name="RefreshCcw" size={18} /> 다시</button>
                        <button onClick={() => { playSfx(); onComplete(data); }} className="flex-[2] py-4 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-500 transition-colors flex items-center justify-center gap-2 shadow-lg shadow-blue-900/50"><Icon name="CheckCircle" size={18} /> 시작하기</button>
                      </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        function LobbyScreen({ mode, selections, onPlay, onNavigate, playSfx, isSidebarOpen, setIsSidebarOpen }) {
          const isAdult = mode === '19';
          const [bannerIdx1, setBannerIdx1] = useState(0);
          const [bannerIdx2, setBannerIdx2] = useState(0);
          const [rankingTab, setRankingTab] = useState('webtoon');
          const [rankingFilter, setRankingFilter] = useState('all');
          const [searchTerm, setSearchTerm] = useState(''); // 검색어 상태
          const searchInputRef = useRef(null);
          const [isSearchFocused, setIsSearchFocused] = useState(false); // 검색창 focus 상태
          const [isSearchPanelVisible, setIsSearchPanelVisible] = useState(false); // 검색 패널 전체 표시 상태

          useEffect(() => { 
              const timer1 = setInterval(() => { setBannerIdx1((prev) => (prev + 1) % BANNERS_PRIMARY.length); }, 4000); 
              const timer2 = setInterval(() => { setBannerIdx2((prev) => (prev + 1) % BANNERS_SECONDARY.length); }, 5000);
              return () => { clearInterval(timer1); clearInterval(timer2); };
          }, []);
          
          const DAILY_PICKS = [
              { title: "시절인연", img: "Book", author: "썸머" },
              { title: "해빙곡선", img: "Zap", author: "피비" },
              { title: "뿌리 없는 나무", img: "Moon", author: "라포" },
              { title: "언슬립", img: "Heart", author: "현외" },
              { title: "백라이트", img: "Lock", author: "강또" }
          ];

          const EXCLUSIVE_NEW_RELEASES = [
            { title: "징크스", author: "밍과", tags: "현대/일상", icon: "Crown", coverColor: "bg-purple-700" },
            { title: "야화첩", author: "변덕", tags: "동양/조선", icon: "Shield", coverColor: "bg-red-700" },
            { title: "페이백", author: "푸죠킹 samk", tags: "현대/일상", icon: "Key", coverColor: "bg-indigo-700" },
          ];

          const LATEST_NEW_RELEASES = [
            { title: "원룸 조교님", author: "지붕", tags: "현대", icon: "Users", coverColor: "bg-green-700" },
            { title: "가족간계증명서", author: "소루", tags: "현대/판타지", icon: "RefreshCcw", coverColor: "bg-blue-700" },
            { title: "홍실퀘스트", author: "숲이랑", tags: "현대/판타지", icon: "Heart", coverColor: "bg-pink-700" },
          ];

          const RANKING_FILTERS = [
              { id: 'all', label: '전체' }, { id: 'romance', label: '로맨스' }, { id: 'fantasy', label: '판타지' }, { id: 'drama', label: '드라마' }, { id: 'etc', label: '기타' }
          ];

          const REALTIME_SEARCH_TERMS = [
              '불우한 삶', '이웃집 길드원', '패션', '뉴비와 올드비의 공생관계', '스케치'
          ];
          
          // 현재 읽고 있는 작품 (My Home용)
          const currentlyReading = PURCHASED_BOOKS.find(b => b.progress > 0 && b.progress < 100) || PURCHASED_BOOKS[0]; // 기본값: 첫 번째 작품

          const handleSearchTermClick = (term) => {
              setSearchTerm(term);
              setIsSearchFocused(false);
              setIsSearchPanelVisible(false); // 검색어 선택 후 패널 닫기
              // Note: For a real app, this would trigger a search results screen navigation.
          };

          return (
            <div className="w-full h-full flex flex-col text-white absolute inset-0 z-10 bg-[#00264B]">
              <div className="absolute inset-0 bg-gradient-to-b from-[#00264B] via-[#0f1524] to-black opacity-90 pointer-events-none"></div>
              
              {/* Top Bar (Sticky and responsive to sidebar) */}
              <div className={`flex justify-between items-center p-6 border-b border-white/10 bg-[#00264B]/60 backdrop-blur-md z-30 sticky top-0 transition-all duration-300 ${isSidebarOpen ? 'md:ml-24' : 'md:ml-0'}`}>
                
                {/* LEFT: Menu Toggle */}
                <div className="flex items-center gap-3">
                  {/* Menu Toggle (Desktop Only) */}
                  <button onClick={() => setIsSidebarOpen(prev => !prev)} className="hidden md:block bg-black/40 p-2 rounded-full border border-white/10 hover:bg-black/60 transition-colors mr-2">
                    <Icon name={isSidebarOpen ? "ChevronLeft" : "Menu"} size={20} className="text-white" />
                  </button>
                </div>
                
                {/* RIGHT GROUP: Search + Currency + Profile */}
                <div className="flex items-center gap-4"> 
                  
                  {/* 1. Search Icon (Toggle visibility of the search panel) */}
                  <button onClick={() => setIsSearchPanelVisible(prev => !prev)} className="bg-black/40 p-2 rounded-full border border-white/10 hover:bg-black/60 transition-colors">
                      <Icon name="Search" size={20} className="text-white" />
                  </button>

                  {/* 2. Currency (Stacked vertically) - Aligned items-end to push tokens right */}
                  <div className="flex flex-col items-end leading-tight"> 
                    <div className="flex items-center gap-1.5 bg-black/40 px-3 py-1.5 rounded-full border border-white/10 cursor-default"><div className="w-3 h-3 rounded-full bg-yellow-500 shadow-[0_0_5px_gold]"></div><span className="text-xs md:text-sm font-bold text-yellow-400">1,234,567,890 G</span></div>
                    <div className="flex items-center gap-1.5 bg-black/40 px-3 py-1.5 rounded-full border border-white/10 cursor-default"><div className="w-3 h-3 bg-green-500 transform rotate-45 shadow-[0_0_5px_lime]"></div><span className="text-xs md:text-sm font-bold text-green-400">9999999장</span></div>
                  </div>
                  
                  {/* 3. Profile (Far Right) */}
                  <div className="flex items-center gap-4 cursor-pointer hover:bg-white/5 p-2 rounded-lg transition-colors" onClick={() => onNavigate('profile')}>
                      <div className="leading-tight text-right">
                          <div className="text-base font-bold">우주인님</div>
                          <div className="text-xs text-blue-200">LV. 1000</div>
                      </div>
                      <div className="w-12 h-12 rounded-full bg-gray-700 overflow-hidden border-2 border-white/20 flex items-center justify-center">
                          <Icon name="User" className="text-gray-400" size={28} />
                      </div>
                  </div>
                </div>
              </div>
              
              {/* Search Panel (Conditional & Sticky) */}
              {isSearchPanelVisible && (
                <section className={`absolute w-full z-10 transition-all duration-300 md:ml-0 md:w-full`} style={{ top: '6rem' }}>
                    <div className={`max-w-7xl mx-auto px-6 transition-all duration-300 ${isSidebarOpen ? 'md:ml-24 md:w-[calc(100%-6rem)]' : 'md:ml-0 md:w-full'}`}>
                        <div className="bg-[#1a1a2e] p-6 rounded-3xl border border-white/10 shadow-2xl">
                            <div className="relative mb-6">
                                <input
                                    ref={searchInputRef}
                                    type="text"
                                    placeholder="작품명, 작가, 키워드 검색"
                                    className="w-full bg-black/40 border border-white/20 rounded-xl py-3 pl-10 pr-4 text-sm text-white focus:outline-none focus:border-blue-500 transition-colors"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    onFocus={() => setIsSearchFocused(true)} // 검색창 클릭 시 (focus) 상태 ON
                                    onBlur={() => setTimeout(() => setIsSearchFocused(false), 150)} // 블러 시 상태 OFF (딜레이)
                                    autoFocus // 패널 열릴 때 자동 포커스
                                />
                                <Icon name="Search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={16} />
                            </div>

                            {/* Display Realtime Search Terms only if search bar is focused */}
                            {isSearchFocused && !searchTerm && ( 
                                <div className="space-y-2 animate-fade-in-up">
                                    <h3 className="text-sm font-bold text-gray-400 mb-3 flex items-center gap-1"><Icon name="TrendingUp" size={16} className="text-red-400" /> 실시간 인기 검색</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {REALTIME_SEARCH_TERMS.slice(0, 6).map((term, idx) => (
                                            <button key={idx} onClick={() => handleSearchTermClick(term)} className="flex items-center text-left gap-2 text-sm text-white hover:text-blue-300 transition-colors truncate">
                                                <span className={`font-bold w-4 ${idx < 3 ? 'text-yellow-400' : 'text-gray-500'}`}>{idx + 1}</span>
                                                <span className="truncate">{term}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {searchTerm && (
                                <div className="mt-4">
                                    <h3 className="text-lg font-bold text-blue-300">검색 결과: "{searchTerm}"</h3>
                                    <p className="text-sm text-gray-400 mt-2">검색된 작품 리스트가 여기에 표시됩니다.</p>
                                    {/* Search results display placeholder */}
                                </div>
                            )}
                            
                        </div>
                    </div>
                </section>
              )}


              {/* Content Area (Handles Sidebar Margin) */}
              <div className={`flex-1 overflow-y-auto custom-scrollbar space-y-12 pb-32 md:pb-12 relative z-0 transition-all duration-300 ${isSidebarOpen ? 'md:ml-24' : 'md:ml-0'}`} style={{ paddingTop: isSearchPanelVisible ? '0' : '6px' }}> 
                
                {/* 7. Keyword Search & Realtime Best (MOVED TO TOP OF CONTENT) */}
                <section className="max-w-7xl mx-auto">
                    <div className="bg-[#1a1a2e] p-6 rounded-3xl border border-white/10">
                        <div className="relative mb-6">
                            <input
                                ref={searchInputRef}
                                type="text"
                                placeholder="작품명, 작가, 키워드 검색"
                                className="w-full bg-black/40 border border-white/20 rounded-xl py-3 pl-10 pr-4 text-sm text-white focus:outline-none focus:border-blue-500 transition-colors"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                onFocus={() => setIsSearchFocused(true)} // 검색창 클릭 시 (focus) 상태 ON
                                onBlur={() => setTimeout(() => setIsSearchFocused(false), 150)} // 블러 시 상태 OFF (딜레이)
                            />
                            <Icon name="Search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={16} />
                        </div>

                        {/* Display Realtime Search Terms only if search bar is focused */}
                        {isSearchFocused && !searchTerm && ( 
                            <div className="space-y-2 animate-fade-in-up">
                                <h3 className="text-sm font-bold text-gray-400 mb-3 flex items-center gap-1"><Icon name="TrendingUp" size={16} className="text-red-400" /> 실시간 인기 검색</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {REALTIME_SEARCH_TERMS.slice(0, 6).map((term, idx) => (
                                        <button key={idx} onClick={() => { setSearchTerm(term); searchInputRef.current?.blur(); }} className="flex items-center text-left gap-2 text-sm text-white hover:text-blue-300 transition-colors truncate">
                                            <span className={`font-bold w-4 ${idx < 3 ? 'text-yellow-400' : 'text-gray-500'}`}>{idx + 1}</span>
                                            <span className="truncate">{term}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {searchTerm && (
                            <div className="mt-4">
                                <h3 className="text-lg font-bold text-blue-300">검색 결과: "{searchTerm}"</h3>
                                <p className="text-sm text-gray-400 mt-2">검색된 작품 리스트가 여기에 표시됩니다.</p>
                                {/* Search results display placeholder */}
                            </div>
                        )}
                        
                    </div>
                </section>

                {/* 1. Banner Section (UPDATED TO TWO CAROUSELS) */}
                <section className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 px-6">
                    {/* Primary Carousel (Event/Notice) */}
                    <BannerCarousel
                        banners={BANNERS_PRIMARY}
                        currentIdx={bannerIdx1}
                        playSfx={playSfx}
                        onPlay={() => onNavigate('notice')} // FIX: Navigate to notice screen
                        className="h-48 md:h-64"
                    />
                    
                    {/* Secondary Carousel (Recommendation/Sale) */}
                    <BannerCarousel
                        banners={BANNERS_SECONDARY}
                        currentIdx={bannerIdx2}
                        playSfx={playSfx}
                        onPlay={() => onNavigate('notice')} // FIX: Navigate to notice screen
                        className="h-48 md:h-64"
                    />
                </section>

                {/* 2. My Home (이어보기 - with Progress) */}
                <section className="max-w-7xl mx-auto px-6">
                    <h2 className="text-xl font-bold mb-4 px-1 flex items-center gap-2 text-blue-100"><Icon name="Home" size={20} /> 최근 감상작</h2>
                    <div onClick={onPlay} className="w-full bg-gray-800 rounded-2xl p-6 flex items-center gap-6 cursor-pointer hover:bg-gray-700 transition-colors border border-white/5 relative overflow-hidden group">
                        <div className="absolute inset-0 bg-gradient-to-r from-blue-900/20 to-transparent"></div>
                        <div className="w-16 h-16 bg-black/40 rounded-xl flex items-center justify-center border border-white/10 z-10 group-hover:scale-105 transition-transform">
                            <Icon name="BookOpen" className="text-blue-300" />
                        </div>
                        <div className="z-10 flex-1">
                            <span className="text-xs text-blue-300 font-bold mb-1 block">읽던 작품 ({currentlyReading.progress}% 진행중)</span>
                            <h3 className="text-lg font-bold text-white">{currentlyReading.title}</h3>
                            <div className="w-full h-1.5 bg-gray-600 rounded-full mt-2 overflow-hidden">
                                <div className="h-full bg-blue-400" style={{width: `${currentlyReading.progress}%`}}></div>
                            </div>
                        </div>
                        <div className="z-10 bg-white/10 p-2 rounded-full"><Icon name="Play" size={16} fill="white" /></div>
                    </div>
                </section>

                {/* 3. New Releases (TC Exclusive / Latest) - UPDATED TO SIDE-BY-SIDE GRID */}
                <section className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 px-6">
                    
                    {/* TC 독점 신작 */}
                    <div className="space-y-4">
                        <h2 className="text-xl font-bold px-1 flex items-center gap-2 text-purple-200"><Icon name="Crown" size={20} /> TC 독점 신작</h2>
                        <div className="flex gap-4 overflow-x-auto pb-2 custom-scrollbar">
                            {EXCLUSIVE_NEW_RELEASES.map((book, idx) => (
                                <div key={idx} className="min-w-[130px] w-[130px] cursor-pointer group hover:-translate-y-1 transition-transform relative" onClick={onPlay}>
                                    {/* Cover Placeholder */}
                                    <div className={`aspect-[3/4] rounded-lg ${book.coverColor} flex items-center justify-center relative overflow-hidden shadow-xl border border-purple-500/30`}>
                                        <div className="absolute inset-0 bg-black/30 group-hover:bg-black/10 transition-colors"></div>
                                        <span className="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-bl-lg z-10">ONLY</span>
                                        <Icon name={book.icon} size={32} className="text-white opacity-60" />
                                    </div>
                                    {/* Info */}
                                    <div className="mt-2 text-sm text-center">
                                        <h4 className="font-bold truncate text-white">{book.title}</h4>
                                        <p className="text-xs text-gray-500 truncate">{book.author}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 최신 공개 신작 */}
                    <div className="space-y-4">
                        <h2 className="text-xl font-bold px-1 flex items-center gap-2 text-blue-200"><Icon name="Sparkles" size={20} /> 최신 공개 신작</h2>
                        <div className="flex gap-4 overflow-x-auto pb-2 custom-scrollbar">
                            {LATEST_NEW_RELEASES.map((book, idx) => (
                                <div key={idx} className="min-w-[130px] w-[130px] cursor-pointer group hover:-translate-y-1 transition-transform relative" onClick={onPlay}>
                                    {/* Cover Placeholder */}
                                    <div className={`aspect-[3/4] rounded-lg ${book.coverColor} flex items-center justify-center relative overflow-hidden shadow-xl border border-blue-500/30`}>
                                         <div className="absolute inset-0 bg-black/30 group-hover:bg-black/10 transition-colors"></div>
                                        <Icon name={book.icon} size={32} className="text-white opacity-60" />
                                    </div>
                                    {/* Info */}
                                    <div className="mt-2 text-sm text-center">
                                        <h4 className="font-bold truncate text-white">{book.title}</h4>
                                        <p className="text-xs text-gray-500 truncate">{book.author}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </section>


                {/* 4. Daily Recommendations */}
                <section className="max-w-7xl mx-auto px-6">
                    <h2 className="text-xl font-bold mb-4 px-1 flex items-center gap-2 text-white"><Icon name="Calendar" size={20} /> 화요일 추천 웹툰</h2>
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                        {DAILY_PICKS.map((item, idx) => (
                            <div key={idx} className="bg-gray-800 rounded-xl overflow-hidden cursor-pointer hover:-translate-y-1 transition-transform group">
                                <div className="aspect-[3/4] bg-gray-900 flex items-center justify-center relative">
                                    <div className="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors"></div>
                                    <Icon name={item.img} className="text-gray-600 group-hover:text-blue-300 transition-colors" size={32} />
                                </div>
                                <div className="p-3">
                                    <h4 className="font-bold text-sm truncate">{item.title}</h4>
                                    <p className="text-xs text-gray-500">{item.author}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </section>

                {/* 5. Real-time Ranking (Re-arranged) */}
                <section className="max-w-7xl mx-auto bg-[#0f1524] rounded-3xl p-6 border border-white/5 px-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-red-400"><Icon name="Flame" size={20} /> 실시간 베스트</h2>
                        <div className="flex bg-black/40 rounded-lg p-1">
                            <button onClick={() => setRankingTab('webtoon')} className={`px-4 py-1 text-xs font-bold rounded ${rankingTab === 'webtoon' ? 'bg-white text-black' : 'text-gray-400'}`}>웹툰</button>
                            <button onClick={() => setRankingTab('novel')} className={`px-4 py-1 text-xs font-bold rounded ${rankingTab === 'novel' ? 'bg-white text-black' : 'text-gray-400'}`}>웹소설</button>
                        </div>
                    </div>
                    
                    <div className="flex gap-2 overflow-x-auto pb-4 custom-scrollbar mb-4">
                        {RANKING_FILTERS.map(filter => (
                            <button key={filter.id} onClick={() => setRankingFilter(filter.id)} className={`px-3 py-1.5 rounded-full text-xs border whitespace-nowrap transition-colors ${rankingFilter === filter.id ? 'bg-blue-600 border-blue-600 text-white' : 'border-gray-700 text-gray-400 hover:border-gray-500'}`}>
                                {filter.label}
                            </button>
                        ))}
                    </div>

                    <div className="space-y-3">
                        {[1, 2, 3, 4, 5].map(rank => (
                            <div key={rank} className="flex items-center gap-4 p-3 hover:bg-white/5 rounded-xl transition-colors cursor-pointer">
                                <span className={`text-xl font-bold italic w-6 text-center ${rank <= 3 ? 'text-yellow-400' : 'text-gray-500'}`}>{rank}</span>
                                <div className="w-12 h-12 bg-gray-800 rounded-lg flex-shrink-0 flex items-center justify-center"><Icon name="Image" size={16} className="text-gray-600" /></div>
                                <div className="flex-1 min-w-0">
                                    <h4 className="font-bold text-sm truncate text-white">{rankingTab === 'webtoon' ? `인기 웹툰 제목 ${rank}` : `인기 소설 제목 ${rank}`}</h4>
                                    <p className="text-xs text-gray-500 truncate">작가 이름 · {rankingFilter === 'all' ? '로맨스' : RANKING_FILTERS.find(f => f.id === rankingFilter).label}</p>
                                </div>
                                <div className="text-xs text-red-400 flex items-center gap-1"><Icon name="TrendingUp" size={12} /> UP</div>
                            </div>
                        ))}
                    </div>
                </section>

                {/* 6. Wait for Free */}
                <section className="max-w-7xl mx-auto px-6">
                    <h2 className="text-xl font-bold mb-4 px-1 flex items-center gap-2 text-yellow-200"><Icon name="Clock" size={20} /> 기다리면 무료</h2>
                    <div className="flex gap-4 overflow-x-auto pb-4 custom-scrollbar snap-x px-1">
                       {[1, 2, 3, 4, 5].map((item, idx) => (
                         <div key={idx} className="min-w-[140px] bg-gray-800 rounded-xl relative overflow-hidden cursor-pointer snap-start border border-white/5 shadow-md group">
                            <div className="aspect-[3/4] bg-gradient-to-b from-gray-700 to-gray-900 relative">
                                <div className="absolute top-2 right-2 bg-black/60 px-2 py-1 rounded-full flex items-center gap-1 backdrop-blur-sm">
                                    <Icon name="Clock" size={10} className="text-yellow-400" />
                                    <span className="text-[10px] font-bold text-white">12h</span>
                                </div>
                            </div>
                            <div className="p-3">
                                <h4 className="font-bold text-sm text-white truncate">기다무 작품 {item}</h4>
                                <span className="text-[10px] text-gray-400">12시간마다 무료</span>
                            </div>
                         </div>
                       ))}
                    </div>
                </section>

                {/* 8. Webtoon / Webnovel Best (Re-arranged) */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-7xl mx-auto px-6">
                    <section>
                        <h2 className="text-xl font-bold mb-4 px-1 text-green-300">웹툰 베스트</h2>
                        <div className="bg-[#0f1524] rounded-2xl p-4 space-y-3 border border-white/5">
                            {[1, 2, 3].map(i => (
                                <div key={i} className="flex gap-4 items-center">
                                    <div className="w-16 h-20 bg-gray-800 rounded-lg"></div>
                                    <div>
                                        <div className="text-sm font-bold text-white">베스트 웹툰 {i}</div>
                                        <div className="text-xs text-gray-500">로맨스 · 작가명</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                    <section>
                        <h2 className="text-xl font-bold mb-4 px-1 text-blue-300">웹소설 베스트</h2>
                        <div className="bg-[#0f1524] rounded-2xl p-4 space-y-3 border border-white/5">
                            {[1, 2, 3].map(i => (
                                <div key={i} className="flex gap-4 items-center">
                                    <div className="w-16 h-20 bg-gray-800 rounded-lg"></div>
                                    <div>
                                        <div className="text-sm font-bold text-white">베스트 소설 {i}</div>
                                        <div className="text-xs text-gray-500">판타지 · 작가명</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                </div>

              </div>
            </div>
          );
        }

        function LibraryScreen({ onBack }) {
             // 데이터 상단으로 이동
             const [filter, setFilter] = useState('all'); // all, webtoon, novel, exclusive

             const filterBooks = () => {
                 return PURCHASED_BOOKS.filter(book => {
                     if (filter === 'all') return true;
                     if (filter === 'webtoon') return book.type === '웹툰';
                     if (filter === 'novel') return book.type === '웹소설';
                     if (filter === 'exclusive') return book.isExclusive;
                     return true;
                 });
             };
             
             const filteredRecords = filterBooks();

             return (
                 <div className="w-full h-full flex flex-col bg-[#00264B] absolute inset-0 z-20 animate-fade-in md:pl-24">
                    <div className="flex flex-col p-6 border-b border-white/10 bg-[#001a33]/80 backdrop-blur-md">
                        <div className="flex items-center mb-4">
                            <button onClick={onBack} className="p-2 -ml-2 hover:bg-white/10 rounded-full transition-colors md:hidden"><Icon name="ArrowLeft" className="text-white"/></button>
                            <h2 className="text-2xl font-bold ml-2">서재 (My Bookshelf)</h2>
                        </div>
                        
                        {/* Filter Tabs */}
                        <div className="flex gap-2 overflow-x-auto custom-scrollbar pb-1">
                            {[
                                { id: 'all', label: '전체' },
                                { id: 'webtoon', label: '웹툰' },
                                { id: 'novel', label: '웹소설' },
                                { id: 'exclusive', label: '독점' }
                            ].map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setFilter(item.id)}
                                    className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${
                                        filter === item.id 
                                            ? 'bg-blue-600 text-white shadow-lg' 
                                            : 'bg-black/30 text-gray-400 hover:bg-black/50'
                                    }`}
                                >
                                    {item.label} ({PURCHASED_BOOKS.filter(b => item.id === 'all' || b.type.includes(item.label) || (item.id === 'exclusive' && b.isExclusive)).length})
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
                            {filteredRecords.length > 0 ? filteredRecords.map(book => (
                                <div key={book.id} className={`p-4 rounded-2xl border transition-all hover:scale-[1.02] cursor-pointer group ${book.progress === 100 ? 'border-green-400/30 bg-green-900/10' : 'border-blue-400/30 bg-blue-900/20 hover:bg-blue-900/40'}`}>
                                    <div className="flex justify-between items-start mb-4">
                                        <div className={`p-2 rounded-xl ${book.progress === 100 ? 'bg-green-600' : 'bg-blue-500'}`}>
                                            <Icon name={book.progress === 100 ? 'CheckCircle' : 'BookOpen'} className="text-white" size={18} />
                                        </div>
                                        <div className="flex flex-col items-end gap-1">
                                            {book.isExclusive && <span className="text-xs bg-red-600 text-white px-2 py-0.5 rounded-full font-bold">ONLY</span>}
                                            <span className={`text-xs px-2 py-0.5 rounded-full font-bold ${book.type === '웹툰' ? 'bg-green-500/20 text-green-300' : 'bg-purple-500/20 text-purple-300'}`}>{book.type}</span>
                                        </div>
                                    </div>
                                    <h3 className={`text-xl font-bold mb-2 ${book.progress === 100 ? 'text-green-300' : 'text-white'}`}>{book.title}</h3>
                                    
                                    <div className="mt-4">
                                        <span className="text-xs text-gray-400 block mb-1">
                                            {book.progress === 100 ? '정주행 완료' : (book.progress === 0 ? '읽기 시작' : `${book.progress}% 진행중`)}
                                        </span>
                                        <div className="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                                            <div className={`h-full ${book.progress === 100 ? 'bg-green-400' : 'bg-blue-400'}`} style={{width: `${book.progress}%`}}></div>
                                        </div>
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center p-10 col-span-full bg-white/5 rounded-xl border border-white/10">
                                    <Icon name="SearchX" size={32} className="text-gray-600 mx-auto mb-3" />
                                    <p className="text-gray-400 text-lg font-bold">구매한 작품이 없습니다.</p>
                                    <p className="text-sm text-gray-500">상점에서 원하는 작품을 선택해보세요!</p>
                                </div>
                            )}
                        </div>
                    </div>
                 </div>
             ); 
        }

        function ShopScreen({ onBack }) { 
            return (
                <div className="w-full h-full flex flex-col bg-[#00264B] absolute inset-0 z-20 animate-fade-in md:pl-24">
                   <div className="flex items-center p-6 border-b border-white/10 bg-[#001a33]/80 backdrop-blur-md">
                       <button onClick={onBack} className="p-2 -ml-2 hover:bg-white/10 rounded-full transition-colors md:hidden"><Icon name="ArrowLeft" className="text-white"/></button>
                       <h2 className="text-2xl font-bold ml-2">상점 (Shop)</h2>
                       <div className="ml-auto flex gap-4">
                            <span className="text-sm font-bold text-yellow-400 bg-black/40 px-4 py-2 rounded-full border border-white/10">1,000 G</span>
                       </div>
                   </div>
                   <div className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                       <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">
                           {ITEMS.map(item => (
                               <div key={item.id} className="bg-[#0f1524] rounded-2xl p-6 border border-white/10 flex flex-col items-center text-center hover:border-blue-400 transition-all hover:-translate-y-2 shadow-lg group">
                                   <div className="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-4 text-blue-200 group-hover:scale-110 transition-transform shadow-[0_0_15px_rgba(0,0,0,0.5)]">
                                       <Icon name={item.icon} size={32} />
                                   </div>
                                   <h3 className="font-bold text-lg mb-2 text-white">{item.name}</h3>
                                   <p className="text-xs text-gray-400 mb-6 h-8 leading-relaxed">{item.desc}</p>
                                   <button className="w-full py-3 bg-blue-700 hover:bg-blue-600 rounded-xl text-sm font-bold transition-colors shadow-lg flex items-center justify-center gap-2">
                                       <span>구매</span>
                                       <span className="opacity-70">|</span>
                                       <span>{item.price}</span>
                                   </button>
                               </div>
                           ))}
                       </div>
                   </div>
                </div>
            ); 
        }

        function ProfileScreen({ onBack }) { 
            return (
                <div className="w-full h-full flex flex-col bg-[#00264B] absolute inset-0 z-20 animate-fade-in md:pl-24">
                   <div className="relative h-80 bg-gradient-to-br from-blue-900 via-[#00264B] to-black">
                       <button onClick={onBack} className="absolute top-8 left-6 p-2 z-10 hover:bg-white/10 rounded-full transition-colors md:hidden"><Icon name="ArrowLeft" className="text-white"/></button>
                       <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                       <div className="absolute -bottom-12 left-1/2 transform -translate-x-1/2 md:left-24 md:translate-x-0 flex flex-col md:flex-row items-center md:items-end gap-6 w-full px-6">
                           <div className="w-32 h-32 rounded-full bg-gray-800 border-4 border-[#00264B] overflow-hidden flex items-center justify-center shadow-2xl relative z-10">
                               <Icon name="User" size={64} className="text-gray-400" />
                           </div>
                           <div className="text-center md:text-left mb-4 md:mb-2">
                               <h2 className="text-3xl font-bold text-white drop-shadow-md">우주님</h2>
                               <span className="text-sm text-blue-200 bg-blue-900/80 px-3 py-1 rounded-full mt-2 inline-block border border-blue-500/30">LV. 1 New Reader</span>
                           </div>
                       </div>
                   </div>
                   <div className="flex-1 pt-20 px-6 max-w-5xl">
                       <div className="grid grid-cols-3 gap-4 text-center mb-10">
                           <div className="bg-white/5 p-6 rounded-2xl border border-white/5"><div className="text-2xl font-bold mb-1">5</div><div className="text-xs text-gray-400 uppercase tracking-wider">Books Read</div></div>
                           <div className="bg-white/5 p-6 rounded-2xl border border-white/5"><div className="text-2xl font-bold mb-1">5</div><div className="text-xs text-gray-400 uppercase tracking-wider">Tickets</div></div>
                           <div className="bg-white/5 p-6 rounded-2xl border border-white/5"><div className="text-2xl font-bold mb-1">2</div><div className="text-xs text-gray-400 uppercase tracking-wider">Endings</div></div>
                       </div>
                       <h3 className="text-lg font-bold mb-4 text-gray-300 border-b border-white/10 pb-2">Account Info</h3>
                       <div className="space-y-4 text-sm bg-black/20 p-6 rounded-2xl border border-white/5">
                           <div className="flex justify-between items-center p-2"><span>User ID</span><span className="text-gray-400 font-mono bg-black/30 px-2 py-1 rounded">USER_82910</span></div>
                           <div className="flex justify-between items-center p-2"><span>Connected Account</span><span className="text-yellow-400 font-bold flex items-center gap-2"><div className="w-2 h-2 bg-yellow-400 rounded-full"></div>Kakao</span></div>
                           <div className="flex justify-between items-center p-2"><span>Version</span><span className="text-gray-500">v1.3.0</span></div>
                       </div>
                   </div>
                </div>
            ); 
        }

        function SettingsScreen({ onBack }) { 
            const [toggles, setToggles] = useState({ bgm: true, sfx: true, push: false });
            return (
                <div className="w-full h-full flex flex-col bg-[#00264B] absolute inset-0 z-20 animate-fade-in md:pl-24">
                   <div className="flex items-center p-6 border-b border-white/10 bg-[#001a33]/80 backdrop-blur-md">
                       <button onClick={onBack} className="p-2 -ml-2 hover:bg-white/10 rounded-full transition-colors md:hidden"><Icon name="ArrowLeft" className="text-white"/></button>
                       <h2 className="text-2xl font-bold ml-2">설정 (Settings)</h2>
                   </div>
                   <div className="flex-1 p-6 max-w-3xl mx-auto w-full">
                       <div className="bg-[#0f1524] rounded-3xl p-8 border border-white/10 shadow-xl space-y-8">
                           <div className="space-y-6">
                               <h3 className="text-sm font-bold text-blue-300 uppercase tracking-widest mb-4">Sound</h3>
                               <div className="flex justify-between items-center hover:bg-white/5 p-3 rounded-xl transition-colors">
                                   <div className="flex items-center gap-3"><Icon name="Music" className="text-gray-400" /> <span>배경음악 (BGM)</span></div>
                                   <button onClick={() => setToggles({...toggles, bgm: !toggles.bgm})} className={`w-12 h-7 rounded-full p-1 transition-all duration-300 ${toggles.bgm ? 'bg-blue-500' : 'bg-gray-600'}`}>
                                       <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${toggles.bgm ? 'translate-x-5' : ''}`}></div>
                                   </button>
                               </div>
                               <div className="flex justify-between items-center hover:bg-white/5 p-3 rounded-xl transition-colors">
                                   <div className="flex items-center gap-3"><Icon name="Volume2" className="text-gray-400" /> <span>효과음 (SFX)</span></div>
                                   <button onClick={() => setToggles({...toggles, sfx: !toggles.sfx})} className={`w-12 h-7 rounded-full p-1 transition-all duration-300 ${toggles.sfx ? 'bg-blue-500' : 'bg-gray-600'}`}>
                                       <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${toggles.sfx ? 'translate-x-5' : ''}`}></div>
                                   </button>
                               </div>
                           </div>
                           
                           <div className="h-px bg-white/10"></div>
                           
                           <div className="space-y-6">
                               <h3 className="text-sm font-bold text-blue-300 uppercase tracking-widest mb-4">Notification</h3>
                               <div className="flex justify-between items-center hover:bg-white/5 p-3 rounded-xl transition-colors">
                                   <div className="flex items-center gap-3"><Icon name="Bell" className="text-gray-400" /> <span>PUSH 알림</span></div>
                                   <button onClick={() => setToggles({...toggles, push: !toggles.push})} className={`w-12 h-7 rounded-full p-1 transition-all duration-300 ${toggles.push ? 'bg-blue-500' : 'bg-gray-600'}`}>
                                       <div className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${toggles.push ? 'translate-x-5' : ''}`}></div>
                                   </button>
                               </div>
                           </div>
                           
                           <div className="pt-8 border-t border-white/10">
                                <button className="w-full py-4 border border-red-500/30 text-red-400 hover:bg-red-500/10 rounded-xl text-sm font-bold transition-colors flex items-center justify-center gap-2">
                                    <Icon name="LogOut" size={16} /> 로그아웃
                                </button>
                           </div>
                       </div>
                       
                       <div className="mt-8 text-center text-xs text-gray-600">
                           <p>Device ID: 8A2-2B1-9C0</p>
                           <p>Server: Asia (Seoul)</p>
                       </div>
                   </div>
                </div>
            ); 
        }

        function NoticeScreen({ onBack }) { return (<div className="w-full h-full flex flex-col bg-[#00264B] absolute inset-0 z-20 md:pl-24 animate-fade-in"><div className="flex items-center p-6 border-b border-white/10 bg-[#001a33]/80 backdrop-blur-md"><button onClick={onBack} className="p-2 -ml-2 hover:bg-white/10 rounded-full transition-colors md:hidden"><Icon name="ArrowLeft" className="text-white"/></button><h2 className="text-2xl font-bold ml-2">공지사항 (Notice)</h2></div><div className="flex-1 text-white flex justify-center items-center text-lg">새로운 이벤트 공지 및 업데이트 정보</div></div>); }
        function HelpScreen({ onBack }) { return (<div className="w-full h-full flex flex-col bg-[#00264B] absolute inset-0 z-20 md:pl-24 animate-fade-in"><div className="flex items-center p-6 border-b border-white/10 bg-[#001a33]/80 backdrop-blur-md"><button onClick={onBack} className="p-2 -ml-2 hover:bg-white/10 rounded-full transition-colors md:hidden"><Icon name="ArrowLeft" className="text-white"/></button><h2 className="text-2xl font-bold ml-2">고객센터 (Help)</h2></div><div className="flex-1 text-white flex justify-center items-center text-lg">자주 묻는 질문(FAQ) 및 1:1 문의</div></div>); }

        function StoryScreen({ onBack }) { 
            const [textIndex, setTextIndex] = useState(0);
            const [viewMode, setViewMode] = useState('game'); // game, webtoon, novel
            const [showModeMenu, setShowModeMenu] = useState(false);
            const [isAuto, setIsAuto] = useState(false);
            const scrollRef = useRef(null);

            const script = [
                { name: '', text: "차가운 공기가 폐부를 찌른다. 익숙한 겨울 냄새... 이곳에 다시 돌아오게 될 줄은 몰랐다." },
                { name: '???', text: "오랜만이네. 이렇게 다시 보게 될 줄은 몰랐어. 기다리고 있었어." },
                { name: '채이언', text: "(그 목소리에 천천히 고개를 들었다. 눈앞에 서 있는 건... 기억 속의 그 사람이다.)" },
                { name: '서 단', text: "왜 그렇게 놀란 표정이야? 도망친 건 너였잖아. 이제 도망갈 곳은 없어." },
                { name: 채이언', text: "강현아... 그게 아니야. 난 그때..." },
                { name: '서 단', text: "변명은 필요 없어. 이제 널 놓아주지 않을 거니까." },
            ];
            
            const handleNext = () => {
                if (textIndex < script.length - 1) setTextIndex(textIndex + 1);
                else {
                    alert("데모 버전의 끝입니다.");
                    onBack();
                }
            };

            const currentLine = script[textIndex];

            // Scroll to bottom for webtoon/novel modes
            useEffect(() => {
                if (viewMode !== 'game' && scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [textIndex, viewMode]);

            return (
                <div onClick={handleNext} className="w-full h-full flex flex-col bg-black absolute inset-0 z-50 animate-fade-in cursor-pointer">
                    
                    {/* --- Controls (Always Visible) --- */}
                    <div className="absolute top-0 left-0 right-0 p-6 flex justify-between z-50 pointer-events-none">
                        <button onClick={(e) => { e.stopPropagation(); onBack(); }} className="bg-black/40 hover:bg-black/60 p-2 rounded-full backdrop-blur border border-white/10 transition-colors pointer-events-auto text-white"><Icon name="X" size={24} /></button>
                        <div className="flex gap-3 pointer-events-auto">
                             <button onClick={(e) => { e.stopPropagation(); setIsAuto(!isAuto); }} className={`px-4 py-1.5 rounded-full text-xs font-bold backdrop-blur border border-white/10 transition-colors ${isAuto ? 'bg-blue-600 text-white' : 'bg-black/40 hover:bg-black/60 text-gray-200'}`}>
                                Auto {isAuto ? 'ON' : 'OFF'}
                             </button>
                             <div className="relative">
                                 <button onClick={(e) => { e.stopPropagation(); setShowModeMenu(!showModeMenu); }} className="bg-black/40 hover:bg-black/60 px-4 py-1.5 rounded-full text-xs font-bold backdrop-blur border border-white/10 transition-colors text-white flex items-center gap-2">
                                     Mode <Icon name={viewMode === 'game' ? 'Gamepad2' : viewMode === 'webtoon' ? 'Scroll' : 'BookOpen'} size={14} />
                                 </button>
                                 {showModeMenu && (
                                     <div className="absolute right-0 top-full mt-2 bg-black/90 border border-white/20 rounded-xl p-2 flex flex-col gap-1 min-w-[120px] shadow-2xl animate-scale-up">
                                         {[
                                             { id: 'game', label: 'Game', icon: 'Gamepad2' },
                                             { id: 'webtoon', label: 'Webtoon', icon: 'Scroll' },
                                             { id: 'novel', label: 'Novel', icon: 'BookOpen' }
                                         ].map(m => (
                                             <button key={m.id} onClick={(e) => { e.stopPropagation(); setViewMode(m.id); setShowModeMenu(false); }} className={`flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-colors ${viewMode === m.id ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-white/10'}`}>
                                                 <Icon name={m.icon} size={14} /> {m.label}
                                             </button>
                                         ))}
                                     </div>
                                 )}
                             </div>
                        </div>
                    </div>

                    {/* --- View Mode: GAME (Default) --- */}
                    {viewMode === 'game' && (
                        <>
                            {/* Background Placeholder */}
                            <div className="absolute inset-0 bg-gradient-to-b from-gray-800 to-black">
                                 <div className="absolute inset-0 opacity-30">
                                    <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-blue-900 via-transparent to-transparent"></div>
                                    <div className="absolute bottom-0 right-0 w-full h-full bg-[radial-gradient(ellipse_at_bottom,_var(--tw-gradient-stops))] from-gray-900 via-transparent to-transparent"></div>
                                 </div>
                                 <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                                     <Icon name="Image" size={128} className="text-white" />
                                 </div>
                            </div>

                            {/* Character */}
                            {currentLine.name === '강현' && (
                                <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-80 md:w-96 h-[80%] bg-gradient-to-t from-blue-900/60 to-transparent backdrop-blur-[2px] border-t-2 border-x-2 border-blue-500/20 rounded-t-[100px] flex items-center justify-center animate-fade-in-up transition-all duration-500">
                                    <span className="text-blue-200 font-bold opacity-50 text-2xl">CHARACTER</span>
                                </div>
                            )}

                            {/* Dialog Box */}
                            <div className="absolute bottom-0 left-0 right-0 p-6 pb-10 flex justify-center z-20">
                                <div className="w-full max-w-4xl relative">
                                    {currentLine.name && (
                                        <div className="absolute -top-10 left-0 bg-blue-900/90 px-6 py-2 rounded-t-xl text-base font-bold text-blue-100 border border-blue-500/30 shadow-lg backdrop-blur-md transform translate-y-1">
                                            {currentLine.name}
                                        </div>
                                    )}
                                    <div className="bg-[#1a1a1a]/90 border border-white/10 rounded-b-xl rounded-tr-xl p-8 shadow-2xl backdrop-blur-md min-h-[160px] md:min-h-[180px] relative">
                                        <p className="text-white text-lg md:text-xl leading-relaxed animate-fade-in font-serif tracking-wide">
                                            {currentLine.text}
                                        </p>
                                        <div className="absolute bottom-4 right-4 animate-bounce opacity-70">
                                            <Icon name="ChevronDown" size={24} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    {/* --- View Mode: WEBTOON --- */}
                    {viewMode === 'webtoon' && (
                        <div ref={scrollRef} className="absolute inset-0 bg-[#121212] overflow-y-auto pt-24 pb-24 px-4 custom-scrollbar">
                            <div className="max-w-2xl mx-auto flex flex-col gap-6">
                                {script.slice(0, textIndex + 1).map((line, idx) => (
                                    <div key={idx} className={`flex gap-3 animate-fade-in-up ${line.name === '나' || !line.name ? 'justify-end' : 'justify-start'}`}>
                                        {line.name && line.name !== '나' && (
                                            <div className="w-10 h-10 rounded-full bg-blue-900 border border-blue-500/30 flex items-center justify-center text-xs font-bold text-white flex-shrink-0 mt-1">
                                                {line.name[0]}
                                            </div>
                                        )}
                                        <div className={`max-w-[80%] flex flex-col ${line.name === '나' || !line.name ? 'items-end' : 'items-start'}`}>
                                            {line.name && line.name !== '나' && <span className="text-xs text-gray-400 mb-1 ml-1">{line.name}</span>}
                                            <div className={`px-5 py-3 rounded-2xl text-base leading-relaxed border ${line.name === '나' ? 'bg-blue-600 text-white rounded-tr-none border-blue-500' : (!line.name ? 'bg-gray-800 text-gray-300 rounded-lg text-center w-full italic border-gray-700' : 'bg-gray-800 text-white rounded-tl-none border-gray-700')}`}>
                                                {line.text}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* --- View Mode: NOVEL --- */}
                    {viewMode === 'novel' && (
                        <div ref={scrollRef} className="absolute inset-0 bg-[#0a0a0a] overflow-y-auto pt-24 pb-24 px-8 md:px-16 custom-scrollbar">
                            <div className="max-w-3xl mx-auto flex flex-col gap-6 animate-fade-in">
                                {script.slice(0, textIndex + 1).map((line, idx) => (
                                    <div key={idx} className={`leading-loose text-lg md:text-xl font-serif tracking-wide ${!line.name ? 'text-gray-400 italic text-center my-4' : 'text-gray-200'}`}>
                                        {line.name && <span className="font-bold text-blue-300 mr-3">[{line.name}]</span>}
                                        {line.text}
                                    </div>
                                ))}
                                <div className="h-20"></div> {/* Bottom Spacer */}
                            </div>
                        </div>
                    )}

                </div>
            ); 
        }

        // --- Collection Screen Component ---
        function CollectionScreen({ onBack }) {
             const [collectionTab, setCollectionTab] = useState('illust');
             const [previewItem, setPreviewItem] = useState(null);

             const COLLECTION_ITEMS = {
                illust: Array.from({ length: 8 }).map((_, i) => ({ id: i, unlocked: i < 3, name: `일러스트 #${i + 1}` })),
                costume: Array.from({ length: 6 }).map((_, i) => ({ id: i, unlocked: i < 2, name: `코스튬 #${i + 1}` })),
                bg: Array.from({ length: 5 }).map((_, i) => ({ id: i, unlocked: i < 3, name: `배경 #${i + 1}` })),
             };

            const handleItemClick = (item) => {
                if (item.unlocked) {
                    setPreviewItem(item);
                }
            };
            
            return (
                <div className="fixed inset-0 z-[100] bg-[#0f1524] flex flex-col animate-fade-in">
                    <div className="flex items-center p-6 border-b border-white/10 bg-[#001a33]/80 backdrop-blur-md">
                        <button onClick={onBack} className="p-2 -ml-2 hover:bg-white/10 rounded-full transition-colors text-white mr-4">
                            <Icon name="ArrowLeft" />
                        </button>
                        <h2 className="text-2xl font-bold text-white flex items-center gap-2"><Icon name="FolderOpen" /> Collection</h2>
                    </div>
                    
                    {/* Tabs */}
                    <div className="flex gap-2 p-6 pb-0 overflow-x-auto custom-scrollbar">
                        {['illust', 'costume', 'bg'].map(tab => (
                            <button 
                                key={tab}
                                onClick={() => setCollectionTab(tab)}
                                className={`px-4 py-2 rounded-full text-sm font-bold capitalize whitespace-nowrap transition-colors ${collectionTab === tab ? 'bg-blue-600 text-white shadow-lg' : 'bg-white/10 text-gray-400'}`}
                            >
                                {tab === 'illust' ? '일러스트' : tab === 'costume' ? '의상' : '배경'}
                            </button>
                        ))}
                    </div>

                    {/* Grid */}
                    <div className="flex-1 overflow-y-auto custom-scrollbar p-6">
                        <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                            {COLLECTION_ITEMS[collectionTab].map((item) => (
                                <div 
                                    key={item.id} 
                                    onClick={() => handleItemClick(item)}
                                    className={`aspect-[3/4] rounded-xl border relative overflow-hidden group cursor-pointer shadow-md ${item.unlocked ? 'bg-gray-700 hover:border-blue-400 transition-colors' : 'bg-black/50 border-gray-700 opacity-50'}`}
                                >
                                    <div className="absolute inset-0 flex items-center justify-center text-center">
                                        {!item.unlocked ? (
                                            <div className="flex flex-col items-center gap-2">
                                                <Icon name="Lock" className="text-gray-500" size={32} />
                                                <span className="text-xs text-gray-500">잠김</span>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-center gap-1 text-white">
                                                <Icon name={collectionTab === 'illust' ? 'Camera' : collectionTab === 'costume' ? 'Shirt' : 'Image'} className="text-white/60" size={24} />
                                                <span className="text-sm font-bold">{item.name}</span>
                                            </div>
                                        )}
                                    </div>
                                    {/* Tooltip for unlocked items */}
                                    {item.unlocked && <div className="absolute inset-0 bg-blue-500/0 group-hover:bg-blue-500/10 transition-colors"></div>}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Preview Modal */}
                    {previewItem && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-md animate-fade-in" onClick={() => setPreviewItem(null)}>
                            <div className="bg-[#1a1a2e] p-6 rounded-2xl max-w-lg w-full shadow-2xl animate-scale-up" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 text-white">프리뷰: {previewItem.name}</h3>
                                <div className={`aspect-video w-full ${previewItem.bg || 'bg-gray-700'} rounded-lg flex items-center justify-center mb-4`}>
                                    <Icon name="Eye" size={48} className="text-white/50" />
                                </div>
                                <p className="text-sm text-gray-400 text-center">여기에 일러스트, 의상 또는 배경 프리뷰가 표시됩니다.</p>
                                <button onClick={() => setPreviewItem(null)} className="w-full mt-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition-colors">닫기</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- My Home Screen (New Live2D Space) ---
        function MyHomeScreen({ onBack, onNavigate }) {
            const [message, setMessage] = useState("어서오세요, 우주님!");
            const [showControls, setShowControls] = useState(false);
            const [charCount, setCharCount] = useState(1); // 1, 2, 3
            const [aiMode, setAiMode] = useState(false);
            
            // Sub-menu state for customization
            const [activeSubMenu, setActiveSubMenu] = useState(null); // 'bg', 'voice', 'costume' or null

            // Dummy Data for Customization
            const BACKGROUNDS = [
                { id: 'bg1', name: '기본 배경', color: 'bg-gray-800' },
                { id: 'bg2', name: '학교 교실', color: 'bg-blue-900' },
                { id: 'bg3', name: '카페 테라스', color: 'bg-yellow-900' },
                { id: 'bg4', name: '밤거리', color: 'bg-purple-900' },
            ];
            const VOICES = [
                { id: 'v1', name: '기본 보이스', desc: '다정한 목소리' },
                { id: 'v2', name: '시크한 보이스', desc: '차가운 목소리' },
                { id: 'v3', name: '장난기 보이스', desc: '활기찬 목소리' },
            ];
            const COSTUMES = [
                { id: 'c1', name: '교복 (동복)', style: 'border-blue-400/30' },
                { id: 'c2', name: '사복 (캐주얼)', style: 'border-green-400/30' },
                { id: 'c3', name: '정장 (수트)', style: 'border-red-400/30' },
            ];

            const [currentBg, setCurrentBg] = useState(BACKGROUNDS[0]);
            const [currentVoice, setCurrentVoice] = useState(VOICES[0]);
            const [currentCostume, setCurrentCostume] = useState(COSTUMES[0]);
            const [showCollection, setShowCollection] = useState(false);


            const handleCharacterClick = (index) => {
                let msgs = [];
                if (aiMode) {
                    msgs = [
                        "우주인님의 취향을 분석해봤어요. 이런 분위기 좋아하시죠?",
                        "지난번에 읽으신 작품... 저랑 비슷했나요?",
                        "우주님, 오늘은 좀 피곤해보이세요. 쉬어가세요.",
                        "데이터 분석 완료. 우주인님을 위한 맞춤 대사입니다.",
                        `우주인님, ${index + 1}번 캐릭터가 마음에 드시나요?`
                    ];
                } else {
                    msgs = [
                        "오늘도 보러 와주셨군요.",
                        "기다리고 있었어요.",
                        "다음 이야기가 궁금하지 않으신가요?",
                        "우주인님, 오늘은 어떤 선택을 하실 건가요?",
                        "제 목소리가 들리시나요?"
                    ];
                }
                setMessage(msgs[Math.floor(Math.random() * msgs.length)]);
            };

            // Calculate character positions based on count
            const getCharacterStyle = (index, total) => {
                if (total === 1) return { left: '50%', zIndex: 10 };
                if (total === 2) {
                    return index === 0 ? { left: '35%', zIndex: 10 } : { left: '65%', zIndex: 10 };
                }
                // total === 3
                if (index === 0) return { left: '50%', zIndex: 20 }; // Center
                if (index === 1) return { left: '25%', zIndex: 10, transform: 'translateX(-50%) scale(0.9)' }; // Left Back
                return { left: '75%', zIndex: 10, transform: 'translateX(-50%) scale(0.9)' }; // Right Back
            };

            return (
                <div className={`w-full h-full absolute inset-0 z-20 animate-fade-in flex flex-col overflow-hidden md:pl-24 transition-colors duration-500 ${currentBg.color}`}>
                    {/* Background Layer (Replaced image with dynamic color for demo) */}
                    <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/20"></div>

                    {/* Top Bar */}
                    <div className="relative z-10 flex items-center justify-between p-6">
                        <h2 className="text-2xl font-bold text-white drop-shadow-md flex items-center gap-2"><Icon name="Heart" className="text-pink-400"/> My Room</h2>
                        <button onClick={() => { setShowControls(!showControls); setActiveSubMenu(null); }} className={`p-2 rounded-full hover:bg-white/20 transition-colors backdrop-blur-sm ${showControls ? 'bg-blue-500 text-white' : 'bg-white/10 text-white'}`}>
                            <Icon name="Edit2" />
                        </button>
                    </div>

                    {/* Character Layer (Live2D Placeholders) */}
                    <div className="flex-1 relative w-full h-full z-0 overflow-hidden">
                        {Array.from({ length: charCount }).map((_, idx) => {
                            const style = getCharacterStyle(idx, charCount);
                            return (
                                <div 
                                    key={idx}
                                    className="absolute bottom-0 w-[60%] max-w-sm h-[80%] bg-gradient-to-t from-white/10 to-transparent animate-breathe cursor-pointer transition-all duration-500 hover:brightness-110 active:scale-95"
                                    onClick={() => handleCharacterClick(idx)}
                                    style={{ 
                                        left: style.left,
                                        transform: `${style.transform || ''} translateX(-50%)`,
                                        zIndex: style.zIndex,
                                        maskImage: 'linear-gradient(to top, black 80%, transparent 100%)',
                                        WebkitMaskImage: 'linear-gradient(to top, black 80%, transparent 100%)'
                                    }}
                                >
                                    {/* Visual Placeholder */}
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <span className="text-white/30 text-8xl font-bold opacity-40 select-none">CHAR {idx + 1}</span>
                                    </div>
                                    <div className={`absolute bottom-0 left-1/2 -translate-x-1/2 w-full h-full border-4 rounded-t-[100px] transition-colors duration-300 ${currentCostume.style}`}></div>
                                </div>
                            );
                        })}

                        {/* Speech Bubble (Shared) */}
                        <div className="absolute top-1/4 left-1/2 -translate-x-1/2 bg-white/90 text-slate-800 px-6 py-3 rounded-2xl rounded-bl-none shadow-lg animate-fade-in-up max-w-xs text-center font-bold text-sm pointer-events-none z-30">
                            {aiMode && <span className="text-[10px] text-blue-500 block mb-1">✨ AI Analysis</span>}
                            {message}
                        </div>
                    </div>

                    {/* Collection Button (Bottom Left) - Adjusted for Sidebar visibility */}
                    <div className="absolute bottom-24 left-6 md:left-32 z-40">
                         <button 
                            onClick={() => onNavigate('collection')} // Navigate to collection screen
                            className="bg-black/60 hover:bg-black/80 backdrop-blur-md p-3 rounded-full border border-white/20 transition-all hover:scale-105 group shadow-lg"
                         >
                            <Icon name="Image" className="text-white group-hover:text-blue-300" />
                         </button>
                         <span className="absolute top-full mt-1 left-1/2 -translate-x-1/2 text-[10px] text-white/70 bg-black/50 px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">컬렉션</span>
                    </div>

                    {/* Controls Panel (Toggleable) */}
                    {showControls && (
                        <div className="absolute bottom-24 left-1/2 -translate-x-1/2 flex flex-col items-center gap-4 z-40 w-full max-w-sm px-6">
                            
                            {/* Sub-Menu List (Dynamic Rendering) */}
                            {activeSubMenu === 'bg' && (
                                <div className="bg-black/90 backdrop-blur-md p-4 rounded-2xl w-full border border-white/10 animate-slide-up mb-2">
                                    <h3 className="text-xs text-gray-400 font-bold mb-3 uppercase">배경 선택</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        {BACKGROUNDS.map(bg => (
                                            <button key={bg.id} onClick={() => setCurrentBg(bg)} className={`p-3 rounded-lg text-sm font-bold transition-all ${currentBg.id === bg.id ? 'bg-blue-600 text-white' : 'bg-white/10 text-gray-400 hover:bg-white/20'}`}>
                                                {bg.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeSubMenu === 'voice' && (
                                <div className="bg-black/90 backdrop-blur-md p-4 rounded-2xl w-full border border-white/10 animate-slide-up mb-2">
                                    <h3 className="text-xs text-gray-400 font-bold mb-3 uppercase">보이스 선택</h3>
                                    <div className="space-y-2">
                                        {VOICES.map(voice => (
                                            <button key={voice.id} onClick={() => { setCurrentVoice(voice); setMessage(`[${voice.name}] 목소리로 변경되었습니다.`); }} className={`w-full p-3 rounded-lg text-left transition-all ${currentVoice.id === voice.id ? 'bg-blue-600 text-white' : 'bg-white/10 text-gray-400 hover:bg-white/20'}`}>
                                                <span className="font-bold block text-sm">{voice.name}</span>
                                                <span className="text-xs opacity-70">{voice.desc}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeSubMenu === 'costume' && (
                                <div className="bg-black/90 backdrop-blur-md p-4 rounded-2xl w-full border border-white/10 animate-slide-up mb-2">
                                    <h3 className="text-xs text-gray-400 font-bold mb-3 uppercase">의상 선택</h3>
                                    <div className="grid grid-cols-3 gap-2">
                                        {COSTUMES.map(costume => (
                                            <button key={costume.id} onClick={() => setCurrentCostume(costume)} className={`p-2 rounded-lg text-xs font-bold transition-all h-20 flex flex-col items-center justify-center gap-2 ${currentCostume.id === costume.id ? 'bg-blue-600 text-white' : 'bg-white/10 text-gray-400 hover:bg-white/20'}`}>
                                                <div className={`w-6 h-6 rounded-full border-2 ${costume.style}`}></div>
                                                {costume.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Main Control Bar */}
                            <div className="bg-black/80 backdrop-blur-md px-6 py-4 rounded-2xl flex flex-col gap-4 border border-white/10 w-full">
                                {/* Character Count Selector */}
                                <div className="flex flex-col gap-2">
                                    <div className="flex bg-white/10 rounded-lg p-1">
                                        {[1, 2, 3].map(num => (
                                            <button 
                                                key={num} 
                                                onClick={() => setCharCount(num)}
                                                className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-colors ${charCount === num ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}
                                            >
                                                {num}인
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* AI Mode Toggle */}
                                <div className="flex items-center justify-between bg-white/5 p-3 rounded-xl">
                                    <div className="flex items-center gap-2">
                                        <div className={`p-1.5 rounded-lg ${aiMode ? 'bg-purple-500 text-white' : 'bg-gray-700 text-gray-400'}`}>
                                            <Icon name="Sparkles" size={14} />
                                        </div>
                                        <span className="text-xs font-bold text-gray-200">AI 분석 대사</span>
                                    </div>
                                    <button 
                                        onClick={() => setAiMode(!aiMode)}
                                        className={`w-10 h-6 rounded-full p-1 transition-colors ${aiMode ? 'bg-purple-500' : 'bg-gray-600'}`}
                                    >
                                        <div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform duration-300 ${aiMode ? 'translate-x-4' : ''}`}></div>
                                    </button>
                                </div>

                                {/* Other Tools Buttons */}
                                <div className="flex justify-around pt-2 border-t border-white/10">
                                    <button 
                                        onClick={() => setActiveSubMenu(activeSubMenu === 'bg' ? null : 'bg')}
                                        className={`flex flex-col items-center gap-1 transition-colors ${activeSubMenu === 'bg' ? 'text-blue-400' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        <Icon name="Image" size={16} />
                                        <span className="text-[9px]">배경</span>
                                    </button>
                                    <button 
                                        onClick={() => setActiveSubMenu(activeSubMenu === 'voice' ? null : 'voice')}
                                        className={`flex flex-col items-center gap-1 transition-colors ${activeSubMenu === 'voice' ? 'text-blue-400' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        <Icon name="Music" size={16} />
                                        <span className="text-[9px]">보이스</span>
                                    </button>
                                    <button 
                                        onClick={() => setActiveSubMenu(activeSubMenu === 'costume' ? null : 'costume')}
                                        className={`flex flex-col items-center gap-1 transition-colors ${activeSubMenu === 'costume' ? 'text-blue-400' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        <Icon name="Shirt" size={16} />
                                        <span className="text-[9px]">의상</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- App Orchestrator ---
        const App = () => {
          const [screen, setScreen] = useState('title');
          const [subScreen, setSubScreen] = useState(null); 
          const [userMode, setUserMode] = useState(null); 
          const [selections, setSelections] = useState({ genre: null, world: null, bdsm: false });
          const [isGuestMode, setIsGuestMode] = useState(false); // 게스트 모드 상태 추가
          const [isSidebarOpen, setIsSidebarOpen] = useState(true); // 사이드바 상태 추가 (App 레벨에서 관리)

          // Navigation Helpers
          const navigateTo = (dest) => {
              if (['lobby', 'library', 'shop', 'profile', 'settings', 'notice', 'help'].includes(dest)) {
                setScreen('lobby');
                setSubScreen(dest);
              } else if (dest === 'myhome') {
                  setScreen('lobby');
                  setSubScreen('myhome');
              } else if (dest === 'collection') {
                  setScreen('collection'); // 컬렉션 화면으로 직접 이동
                  setSubScreen(null);
              } else if (dest === 'backToMyHome') {
                  setScreen('lobby');
                  setSubScreen('myhome');
              } else {
                setScreen(dest);
                setSubScreen(null);
              }
          };

          const handleCompleteLoading = () => navigateTo('ageGate');
          const handleConfirmPermission = () => navigateTo('loading'); 
          const handleSplashComplete = () => navigateTo('permission'); 
          const handleStartGame = () => navigateTo('splash'); 

          const renderScreen = () => {
              switch(screen) {
                  case 'title': return <TitleScreen 
                      onStart={handleStartGame} 
                      isGuestMode={isGuestMode} 
                      setIsGuestMode={setIsGuestMode} 
                      onNavigate={navigateTo} 
                  />;
                  case 'splash': return <SplashScreen onComplete={handleSplashComplete} playSfx={playSoundEffect} />;
                  case 'permission': return <PermissionModal onConfirm={handleConfirmPermission} onCancel={() => navigateTo('title')} playSfx={playSoundEffect} />;
                  case 'loading': return <LoadingScreen onComplete={handleCompleteLoading} />;
                  case 'ageGate': return <AgeGateScreen onSelect={(mode) => { setUserMode(mode); navigateTo('filter'); }} />;
                  case 'filter': return <FilterScreen userMode={userMode} onComplete={(data) => { setSelections(data); navigateTo('lobby'); }} onRestart={() => navigateTo('ageGate')} playSfx={playSoundEffect} />;
                  
                  case 'collection': return <CollectionScreen onBack={() => navigateTo('myhome')} />; // 마이홈으로 돌아가도록 수정

                  case 'lobby': return (
                      <>
                        <LobbyScreen 
                            mode={userMode} 
                            selections={selections} 
                            onPlay={() => navigateTo('story')} 
                            onNavigate={navigateTo} 
                            playSfx={playSoundEffect} 
                            isSidebarOpen={isSidebarOpen}
                            setIsSidebarOpen={setIsSidebarOpen}
                        />
                        {subScreen === 'library' && <LibraryScreen onBack={() => setSubScreen(null)} />}
                        {subScreen === 'shop' && <ShopScreen onBack={() => setSubScreen(null)} />}
                        {subScreen === 'profile' && <ProfileScreen onBack={() => setSubScreen(null)} />}
                        {subScreen === 'settings' && <SettingsScreen onBack={() => setSubScreen(null)} />}
                        {subScreen === 'notice' && <NoticeScreen onBack={() => setSubScreen(null)} />}
                        {subScreen === 'help' && <HelpScreen onBack={() => setSubScreen(null)} />}
                        {subScreen === 'myhome' && <MyHomeScreen onBack={() => setSubScreen(null)} onNavigate={navigateTo} />}
                        {screen !== 'story' && <ResponsiveNavigation currentScreen={subScreen || 'lobby'} onNavigate={navigateTo} playSfx={playSoundEffect} isSidebarOpen={isSidebarOpen} />}
                      </>
                  );
                  case 'story': return <StoryScreen onBack={() => navigateTo('lobby')} />;
                  default: return <TitleScreen onStart={handleStartGame} isGuestMode={isGuestMode} setIsGuestMode={setIsGuestMode} onNavigate={navigateTo} />;
              }
          };

          // 눈 효과는 TitleScreen에서만 표시
          const showSnow = screen === 'title';

          return (
            <div className="relative w-full h-full bg-[#00264B] overflow-hidden">
               {showSnow && <SnowEffect />}
               <div className="relative z-10 w-full h-full">{renderScreen()}</div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>